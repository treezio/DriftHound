<div class="dashboard" data-controller="dashboard-filter">
  <header class="dashboard-header" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.15em; margin-bottom: 1.5em;">
    <img src="/drifthound_logo.png" alt="DriftHound Logo" style="height: 7em; width: 11em; margin-bottom: 0.05em; object-fit: contain;">
    <h1 style="margin: 0; font-size: 2.2em;">DriftHound</h1>
    <p class="subtitle">Terraform Drift Monitor</p>
  </header>

  <!-- Project status summary by aggregated status -->
  <section class="status-summary">
    <div class="status-badge status-ok" data-status-filter="ok" data-dashboard-filter-target="statusBadge" style="cursor:pointer;">
      <span class="count"><%= @project_environment_status_counts["ok"] || 0 %></span>
      <span class="label">OK</span>
    </div>
    <div class="status-badge status-drift" data-status-filter="drift" data-dashboard-filter-target="statusBadge" style="cursor:pointer;">
      <span class="count"><%= @project_environment_status_counts["drift"] || 0 %></span>
      <span class="label">Drift</span>
    </div>
    <div class="status-badge status-error" data-status-filter="error" data-dashboard-filter-target="statusBadge" style="cursor:pointer;">
      <span class="count"><%= @project_environment_status_counts["error"] || 0 %></span>
      <span class="label">Error</span>
    </div>
    <div class="status-badge status-unknown" data-status-filter="unknown" data-dashboard-filter-target="statusBadge" style="cursor:pointer;">
      <span class="count"><%= @project_environment_status_counts["unknown"] || 0 %></span>
      <span class="label">Unknown</span>
    </div>
  </section>

  <section class="projects-list">
    <h2>Projects</h2>
    <% # Collect unique environment names for the filter %>
    <% env_names = @project_environments.map { |_, env| env.name }.uniq.sort %>
    <div class="dashboard-filter-bar">
      <% if env_names.size > 1 %>
        <select id="env-filter" class="filter-pill" data-dashboard-filter-target="envFilter">
          <option value="">üåé All Environments</option>
          <% env_names.each do |name| %>
            <option value="<%= name %>">üå± <%= name %></option>
          <% end %>
        </select>
      <% end %>
      <span class="filter-sep"></span>
      <span class="filter-search">
        <span class="filter-icon">üîç</span>
        <input id="name-filter" type="text" placeholder="Search projects or environments‚Ä¶" class="filter-input" data-dashboard-filter-target="nameFilter">
        <button id="clear-filters" class="filter-clear" title="Clear filters" style="display:none;" data-dashboard-filter-target="clearBtn">‚úï</button>
      </span>
    </div>
    <style>
    .dashboard-filter-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--color-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      padding: 1rem 1.5rem;
      margin-bottom: 1.5em;
    }
    .filter-pill {
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      border-radius: 6px;
      padding: 0 2.5em 0 0.75em;
      font-size: 1em;
      height: 2.5em;
      line-height: 2.5em;
      outline: none;
      transition: border-color 0.15s;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%236b7280" height="16" viewBox="0 0 20 20" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.06l3.71-3.83a.75.75 0 1 1 1.08 1.04l-4.25 4.39a.75.75 0 0 1-1.08 0L5.21 8.27a.75.75 0 0 1 .02-1.06z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 0.75em center;
      background-size: 1em;
      overflow: visible;
    }
    .filter-pill::-ms-expand {
      display: none;
    }
    .filter-pill:focus {
      border-color: #2563eb;
    }
    .filter-sep {
      width: 1px;
      height: 1.5em;
      background: #e5e7eb;
    }
    .filter-search {
      display: flex;
      align-items: center;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 0 0.75em;
      height: 2.5em;
      flex: 1;
      min-width: 0;
    }
    .filter-icon {
      font-size: 1em;
      margin-right: 0.5em;
      color: #9ca3af;
      flex-shrink: 0;
    }
    .filter-input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 1em;
      min-width: 0;
      width: 100%;
    }
    .filter-input::placeholder {
      color: #9ca3af;
    }
    .filter-clear {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 0.15s;
      padding: 0 0.25em;
      margin-left: 0.5em;
    }
    .filter-clear:hover {
      color: #f59e0b;
    }
    </style>
    <% if @project_environments.empty? %>
      <div class="empty-state">
        <p>No projects or environments yet.</p>
        <p class="hint">Projects and environments are created automatically when you submit your first drift check via the API.</p>
      </div>
    <% else %>
      <div class="projects-table" id="projects-table">
        <div class="project-envs-header">
          <span>Project</span>
          <span>Environment</span>
          <span>Status</span>
          <span style="text-align:right;">Last Check</span>
        </div>
        <% @project_environments.each do |project, env| %>
          <%= link_to project_environment_path(project.key, env.key), class: "project-env-row project-row--#{env.status}", data: { environment: env.name, status: env.last_check_status, dashboard_filter_target: "projectRow" } do %>
            <span class="col-project" title="<%= project.name %>"><%= project.name %></span>
            <span class="col-environment" title="<%= env.name %>"><%= env.name %></span>
            <span class="col-status">
              <span class="status-indicator status-indicator--<%= env.last_check_status %>"></span>
              <span class="status-text status-text--<%= env.last_check_status %>"><%= env.last_check_status.upcase %></span>
            </span>
            <span class="col-time" style="text-align:right;">
              <% if env.last_checked_at %>
                <%= time_ago_in_words(env.last_checked_at) %> ago
              <% else %>
                Never
              <% end %>
            </span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </section>
</div>
