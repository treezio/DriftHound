<div class="project-detail">
  <header class="project-header">
    <div class="breadcrumb" title="<%= @project.name %>">
      <%= link_to "DriftHound", root_path %><span class="breadcrumb-sep"> â€º </span><span title="<%= @project.name %>"><%= @project.name %></span>
    </div>
    <%= link_to "â† Back to Dashboard", root_path, class: "back-link" %>
  </header>

  <section class="project-summary-card" data-controller="modal">
    <div class="summary-top">
      <div class="main-info">
        <span class="project-emoji">ğŸ“¦</span>
        <h1 title="<%= @project.name %>"><%= @project.name %></h1>
      </div>
      <div>
        <% if @project.last_checked_at %>
          <span class="last-check-time">ğŸ• Last checked <%= time_ago_in_words(@project.last_checked_at) %> ago</span>
        <% else %>
          <span class="last-check-time">ğŸ• Never checked</span>
        <% end %>
      </div>
    </div>
    <% if @project.repository.present? || @slack_channel.present? || logged_in? %>
      <div class="summary-bottom">
        <div class="summary-bottom-left">
          <% if @project.repository.present? %>
            <span class="project-detail-item">
              <%
                repo_icon = case @project.repository
                when /github\.com/ then "github"
                when /gitlab\.com/ then "gitlab"
                when /bitbucket\.org/ then "bitbucket"
                else "generic"
                end
              %>
              <span class="repo-icon repo-icon--<%= repo_icon %>"></span>
              <%= link_to @project.repository.sub(%r{^https?://}, ''), @project.repository, target: "_blank", rel: "noopener noreferrer" %>
            </span>
          <% end %>
          <% if @slack_channel.present? %>
            <span class="project-detail-item">
              <span class="slack-icon"></span>
              <span class="slack-channel"><%= @slack_channel.config["channel"] %></span>
            </span>
          <% end %>
        </div>
        <% if logged_in? %>
          <div class="summary-bottom-right">
            <button type="button" class="btn btn-danger-outline btn-sm" data-action="click->modal#open">Delete Project</button>
          </div>
        <% end %>
      </div>
    <% end %>
    <%= render "shared/confirm_delete_modal",
      resource_type: "project",
      resource_name: @project.name,
      delete_path: project_path(@project.key),
      cascade_warning: "This will also delete all #{@environments.count} environment(s) and their drift check history." %>
  </section>

  <section class="environments-list">
    <h2>Environments</h2>
    
    <% if @environments.empty? %>
      <div class="empty-state">
        <p>No environments yet.</p>
        <p class="hint">Environments are created automatically when you submit drift checks via the API.</p>
      </div>
    <% else %>
      <div class="environments-table">
        <div class="environments-header">
          <span>Status</span>
          <span>Environment</span>
          <span>Summary</span>
          <span style="text-align: right;">Last Check</span>
          <span></span>
        </div>

        <% @environments.each do |environment| %>
          <%= link_to project_environment_path(@project.key, environment.key), class: "environment-row" do %>
            <span class="col-status">
              <span class="status-indicator status-indicator--<%= environment.status %>"></span>
              <span class="status-text status-text--<%= environment.status %>"><%= environment.status.upcase %></span>
            </span>
            <span class="col-name">
              <span class="environment-name" title="<%= environment.name %>"><%= environment.name %></span>
            </span>
            <span class="col-summary oneline">
              <% last_check = environment.drift_checks.order(created_at: :desc).first %>
              <% if last_check %>
                <% if last_check.ok? %>
                  No changes
                <% elsif last_check.drift? || last_check.error? %>
                  <% parts = [] %>
                  <% parts << "#{last_check.add_count} to add" if last_check.add_count.to_i > 0 %>
                  <% parts << "#{last_check.change_count} to change" if last_check.change_count.to_i > 0 %>
                  <% parts << "#{last_check.destroy_count} to destroy" if last_check.destroy_count.to_i > 0 %>
                  <%= parts.any? ? parts.join(", ") : "â€”" %>
                <% else %>
                  â€”
                <% end %>
              <% else %>
                â€”
              <% end %>
            </span>
            <span class="col-time">
              <% if environment.last_checked_at %>
                <%= time_ago_in_words(environment.last_checked_at) %> ago
              <% else %>
                Never
              <% end %>
            </span>
            <span class="col-arrow">â†’</span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </section>
</div>
