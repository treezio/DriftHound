<div class="environment-detail">
  <header class="project-header">
    <div class="breadcrumb" title="<%= @project.name %> ‚Ä∫ <%= @environment.name %>">
      <%= link_to "DriftHound", root_path %><span class="breadcrumb-sep"> ‚Ä∫ </span><%= link_to @project.name, project_path(@project.key), title: @project.name %><span class="breadcrumb-sep"> ‚Ä∫ </span><span title="<%= @environment.name %>"><%= @environment.name %></span>
    </div>
    <%= link_to "‚Üê Back to #{@project.name}", project_path(@project.key), class: "back-link", title: "Back to #{@project.name}" %>
  </header>

  <section class="project-summary-card" data-controller="modal">
    <div class="summary-top">
      <div class="main-info">
        <% last_status = @environment.last_check_status %>
        <span class="status-indicator status-indicator--<%= last_status %>"></span>
        <h1 title="<%= @project.name %>"><%= @project.name %></h1>
        <span class="env-separator">&bull;</span>
        <span class="environment-title" title="<%= @environment.name %>"><%= @environment.name %></span>
        <span class="env-separator">&bull;</span>
        <span class="status-pill status-pill--<%= last_status %>"><%= last_status.upcase %></span>
      </div>
      <div>
        <% if @environment.last_checked_at %>
          <span class="last-check-time">üïê Last checked <%= time_ago_in_words(@environment.last_checked_at) %> ago</span>
        <% else %>
          <span class="last-check-time">üïê Never checked</span>
        <% end %>
      </div>
    </div>
    <% if @project.repository.present? || @environment.directory.present? || @slack_channel.present? || logged_in? %>
      <div class="summary-bottom">
        <div class="summary-bottom-left">
          <% if @project.repository.present? || @environment.directory.present? %>
            <span class="project-detail-item">
              <%
                repo_icon = case @project.repository
                when /github\.com/ then "github"
                when /gitlab\.com/ then "gitlab"
                when /bitbucket\.org/ then "bitbucket"
                else "generic"
                end
              %>
              <% if @project.repository.present? %>
                <span class="repo-icon repo-icon--<%= repo_icon %>"></span>
                <% if @environment.directory.present? %>
                  <%
                    # Build full path URL for tree view
                    repo_url = @project.repository.sub(/\.git$/, '')
                    branch = @project.branch || "main"
                    # Clean directory path (remove leading ./ or /)
                    clean_directory = @environment.directory.sub(%r{^\.?/}, '')
                    # Build tree path for GitHub/GitLab/Bitbucket
                    tree_path = case @project.repository
                    when /github\.com/ then "tree/#{branch}/#{clean_directory}"
                    when /gitlab\.com/ then "-/tree/#{branch}/#{clean_directory}"
                    when /bitbucket\.org/ then "src/#{branch}/#{clean_directory}"
                    else clean_directory
                    end
                    full_url = "#{repo_url}/#{tree_path}"
                    display_text = "#{@project.repository.sub(%r{^https?://}, '')}/#{clean_directory}"
                  %>
                  <%= link_to display_text, full_url, target: "_blank", rel: "noopener noreferrer" %>
                <% else %>
                  <%= link_to @project.repository.sub(%r{^https?://}, ''), @project.repository, target: "_blank", rel: "noopener noreferrer" %>
                <% end %>
              <% elsif @environment.directory.present? %>
                <span class="directory-icon">üìÅ</span>
                <span class="directory-path"><%= @environment.directory %></span>
              <% end %>
            </span>
          <% end %>
          <% if @slack_channel.present? %>
            <span class="project-detail-item">
              <span class="slack-icon"></span>
              <span class="slack-channel"><%= @slack_channel.config["channel"] %></span>
            </span>
          <% end %>
        </div>
        <% if logged_in? %>
          <div class="summary-bottom-right">
            <button type="button" class="btn btn-danger-outline btn-sm" data-action="click->modal#open">Delete Environment</button>
          </div>
        <% end %>
      </div>
    <% end %>
    <%= render "shared/confirm_delete_modal",
      resource_type: "environment",
      resource_name: @environment.name,
      delete_path: project_environment_path(@project.key, @environment.key),
      cascade_warning: "This will also delete all #{@drift_checks.count} drift check(s) and their history." %>
  </section>

  <section class="check-history">
    <h2>Check History</h2>
    <% if @drift_checks.empty? %>
      <div class="empty-state">
        <p>No drift checks recorded yet.</p>
      </div>
    <% else %>
      <div class="checks-table">
        <div class="checks-header">
          <span style="text-align: center;">#</span>
          <span>Status</span>
          <span>Summary</span>
          <span>Duration</span>
          <span>Execution Time</span>
          <span style="text-align: right;">Details</span>
        </div>
        <% total_checks = @drift_checks.size %>
        <% @drift_checks.each_with_index do |check, idx| %>
          <div class="check-row" data-controller="expandable">
            <div class="check-summary" data-action="click->expandable#toggle">
              <span class="col-check-number">
                <span class="check-number-badge"><%= check.execution_number %></span>
              </span>
              <span class="col-status">
                <span class="status-indicator status-indicator--<%= check.status %>"></span>
                <span class="status-text status-text--<%= check.status %>"><%= check.status.upcase %></span>
              </span>
              <span class="col-summary">
                <% if check.ok? %>
                  No changes
                <% elsif check.drift? || check.error? %>
                  <% parts = [] %>
                  <% parts << "#{check.add_count} to add" if check.add_count.to_i > 0 %>
                  <% parts << "#{check.change_count} to change" if check.change_count.to_i > 0 %>
                  <% parts << "#{check.destroy_count} to destroy" if check.destroy_count.to_i > 0 %>
                  <%= parts.any? ? parts.join(", ") : "‚Äî" %>
                <% else %>
                  ‚Äî
                <% end %>
              </span>
              <span class="col-duration">
                <% if check.duration.present? %>
                  <%= check.duration >= 60 ? "#{check.duration / 60}m #{check.duration % 60}s" : "#{check.duration}s" %>
                <% else %>
                  ‚Äî
                <% end %>
              </span>
              <span class="col-time" title="<%= check.created_at.strftime('%Y-%m-%d %H:%M:%S') %>">
                <%= check.created_at.strftime('%b %d, %I:%M %p') %>
              </span>
              <span class="col-actions">
                <% if check.raw_output.present? %>
                  <button class="expand-btn" data-expandable-target="button">
                    <span class="expand-icon">‚ñ∂</span> Plan
                  </button>
                <% else %>
                  <span class="no-output">‚Äî</span>
                <% end %>
              </span>
            </div>
            <% if check.raw_output.present? %>
              <div class="check-output" data-expandable-target="content" hidden>
                <pre><code><%= check.raw_output %></code></pre>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </section>
</div>
